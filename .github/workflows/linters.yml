name: Linters

on:
  workflow_call:

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    env:
      CMAKE_GENERATOR: Ninja
      CC: clang
      CXX: clang++
    strategy:
      fail-fast: false
      matrix:
        tool: [cppcheck, include-what-you-use]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: source

      - name: Install dependencies
        run: |
          if [ "${{ matrix.tool }}" == "cppcheck" ]; then
            linter_pkg=cppcheck
          elif [ "${{ matrix.tool }}" == "include-what-you-use" ]; then
            linter_pkg=iwyu
          fi
          sudo apt-get install -y \
              build-essential cmake clang ninja-build ${linter_pkg}

      - name: Configure
        run: |
          linter_args=()
          if [ "${{ matrix.linter }}" == "cppcheck" ]; then
            linter_args+=( -DCLANG_TIDY_EXECUTABLE=IGNORE )
            linter_args+=( -DINCLUDE_WHAT_YOU_USE_EXECUTABLE=IGNORE )
          elif [ "${{ matrix.linter }}" == "include-what-you-use" ]; then
            linter_args+=( -DCPPCHECK_EXECUTABLE=IGNORE )
            linter_args+=( -DCLANG_TIDY_EXECUTABLE=IGNORE )
          fi
          cmake \
            -S source \
            -B build \
            -DBUILD_TESTING=OFF \
            -DAUTOCOMPAT_ENABLE_LINTERS=ON \
            "${linter_args[@]}"

      - name: Build
        run: cmake --build build

  clang-tidy:
    name: Clang Tidy
    runs-on: ubuntu-latest
    env:
      CC: clang
      CXX: clang++

    steps:
      - name: Install build dependencies
        run: |
          sudo apt-get install -y \
            build-essential cmake clang clang-tidy

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Install clang-tidy-sarif
        run: cargo install clang-tidy-sarif sarif-fmt

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: source

      - name: Configure
        run: cmake -S source -B build -DBUILD_TESTING=OFF

      - name: Analyze
        run: source/scripts/ci/clang-tidy-sarif.sh source build

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v3
        with:
          checkout_path: source
          sarif_file: clang-tidy.sarif
